name: Release

on:
  push:
    tags:
      - 'v*'

jobs:
  build-and-release:
    name: Build and Release
    runs-on: windows-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Build Windows executable
      run: |
        pyinstaller --onefile --windowed --name JoystickController joystick_controller_final.py
    
    - name: Install PlatformIO
      run: |
        pip install --upgrade platformio
    
    - name: Build Arduino firmware
      run: pio run
    
    - name: Prepare release files
      run: |
        mkdir release-files
        copy dist\JoystickController.exe release-files\
        copy .pio\build\uno\firmware.hex release-files\
        copy README.md release-files\
        copy requirements.txt release-files\
        copy platformio.ini release-files\
        copy src\main.cpp release-files\
        copy *.bat release-files\ 2>nul || echo "No .bat files found"
        copy JoystickController_Release\* release-files\ 2>nul || echo "No release files found"
    
    - name: Create Release
      id: create_release
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ github.ref }}
        release_name: GameBoard ${{ github.ref }}
        body: |
          ## ğŸ® GameBoard Release ${{ github.ref }}
          
          ### ğŸ“¦ åŒ…å«æ–‡ä»¶
          - `JoystickController.exe` - Windows å¯æ‰§è¡Œæ–‡ä»¶
          - `firmware.hex` - Arduino å›ºä»¶æ–‡ä»¶
          - `main.cpp` - Arduino æºä»£ç 
          - `README.md` - ä½¿ç”¨è¯´æ˜
          - å…¶ä»–é…ç½®å’Œè„šæœ¬æ–‡ä»¶
          
          ### ğŸš€ å¿«é€Ÿå¼€å§‹
          1. ä¸‹è½½å¹¶è§£å‹å‘å¸ƒåŒ…
          2. å°† `firmware.hex` ä¸Šä¼ åˆ° Arduino å¼€å‘æ¿
          3. è¿è¡Œ `JoystickController.exe`
          
          ### ğŸ“‹ ç³»ç»Ÿè¦æ±‚
          - Windows 10/11
          - Arduino Uno/Nano + JoystickShield
          - USB è¿æ¥çº¿
          
          ### ğŸ”§ ç¡¬ä»¶è¿æ¥
          è¯·å‚è€ƒ README.md ä¸­çš„ç¡¬ä»¶è¿æ¥è¯´æ˜
        draft: false
        prerelease: false
    
    - name: Upload Release Assets
      run: |
        $files = Get-ChildItem -Path "release-files" -File
        foreach ($file in $files) {
          $asset_name = $file.Name
          $asset_path = $file.FullName
          
          # Upload each file as a release asset
          $headers = @{
            "Authorization" = "token ${{ secrets.GITHUB_TOKEN }}"
            "Content-Type" = "application/octet-stream"
          }
          
          $upload_url = "${{ steps.create_release.outputs.upload_url }}" -replace '\{\?name,label\}', "?name=$asset_name"
          
          try {
            Invoke-RestMethod -Uri $upload_url -Method Post -Headers $headers -InFile $asset_path
            Write-Host "Uploaded: $asset_name"
          } catch {
            Write-Host "Failed to upload: $asset_name - $($_.Exception.Message)"
          }
        }
      shell: powershell
